"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = watcher;

var _chokidar = _interopRequireDefault(require("chokidar"));

var _eslint = _interopRequireDefault(require("eslint"));

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _settings = _interopRequireDefault(require("./settings"));

var _logger = _interopRequireDefault(require("./logger"));

var _clearTerminal = _interopRequireDefault(require("./formatters/helpers/clear-terminal.js"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const logger = (0, _logger.default)('watcher');
logger.debug('Loaded');
const events = {
  change: 'change'
};
const chokidarOptions = {
  ignored: /\.git|node_modules|bower_components/
};
const cliOptionProperties = ['config', 'eslintrc', 'ext', 'parser', 'cache', 'cacheLocation', 'ignore', 'ignorePath', 'ignorePattern', 'fix', 'parserOptions', 'global'];
const cliOptionMap = {
  config: 'configFile',
  eslintrc: 'useEslintrc',
  ext: 'extensions',
  cacheFile: 'cacheLocation'
};

function filterWarnings(results) {
  return _lodash.default.reduce(results, (curr, result) => {
    if (result.warningCount) {
      let newResult = _lodash.default.omit(result, 'messages');

      newResult.messages = _lodash.default.filter(result.messages, m => m.severity > 1);
      curr.push(newResult);
      return curr;
    }

    curr.push(result);
    return curr;
  }, []);
}

function requireFormatter(formatterPath) {
  try {
    return require(formatterPath);
  } catch (ex) {
    ex.message = `There was a problem loading formatter: ${formatterPath}\nError: ${ex.message}`;
    throw ex;
  }
}

function getFormatter(cli, formatter) {
  const pathToFormatterSpecified = formatter.includes('\\');
  const isSimpleFormatter = formatter.includes('simple');
  const formatterPath = formatter.replace(/\\/g, '/');

  if (isSimpleFormatter) {
    logger.debug(`Formatter local: ${formatter}`);
    return requireFormatter(`./formatters/${formatterPath}`);
  } else if (pathToFormatterSpecified) {
    const cwd = process.cwd();
    logger.debug('Formatter user:', formatterPath);

    const location = _path.default.resolve(cwd, formatterPath);

    return requireFormatter(location);
  }

  logger.debug(`Formatter eslint: ${formatter}`);
  return cli.getFormatter(formatter);
} ///https://github.com/eslint/eslint/blob/233440e524aa41545b66b2c3c7ca26fe790e32e0/tests/lib/cli-engine.js#L105-L107


function watcher(options) {
  const cliOptions = (0, _lodash.default)(options).pick(cliOptionProperties).reduce(function (result, value, key) {
    key = cliOptionMap[key] || key;
    result[key] = value;
    return result;
  }, {});
  logger.debug('cli', cliOptions);
  logger.debug('options', options);
  const cli = new _eslint.default.CLIEngine(cliOptions);
  const watchDir = options._.length ? options._ : [_path.default.resolve('./')];
  const formatter = getFormatter(cli, options.format);

  function lintFile(path) {
    logger.debug('lintFile: %s', path);

    if (options.clear) {
      (0, _clearTerminal.default)();
    }

    const report = cli.executeOnFiles(path);

    if (options.fix) {
      _eslint.default.CLIEngine.outputFixes(report);
    }

    const results = _settings.default.cliOptions.quiet ? filterWarnings(report.results) : report.results;
    logger.log(formatter(results));
  }

  function isWatchableExtension(filePath, extensions = cli.options.extensions) {
    const extension = _path.default.extname(filePath);

    const dotExtensions = extensions.map(e => {
      if (!e.match(/^\./)) {
        return `.${e}`;
      }

      return e;
    });
    logger.debug(extension, dotExtensions);

    if (dotExtensions.length > 0) {
      return _lodash.default.includes(dotExtensions, extension);
    } // Use the ESLint default extension, if none is provided


    return _lodash.default.includes(cli.options.extensions, extension);
  }

  _chokidar.default.watch(watchDir, chokidarOptions).on(events.change, function changeEvent(path) {
    logger.debug('Changed:', path);

    if (!cli.isPathIgnored(path) && isWatchableExtension(path, options.ext)) {
      const watchPath = options.changed ? [path] : watchDir;
      lintFile(watchPath);
    }
  }).on('error', logger.error);

  logger.debug('Watching: %o', watchDir);
}

module.exports = exports["default"];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy93YXRjaGVyLmpzIl0sIm5hbWVzIjpbImxvZ2dlciIsImRlYnVnIiwiZXZlbnRzIiwiY2hhbmdlIiwiY2hva2lkYXJPcHRpb25zIiwiaWdub3JlZCIsImNsaU9wdGlvblByb3BlcnRpZXMiLCJjbGlPcHRpb25NYXAiLCJjb25maWciLCJlc2xpbnRyYyIsImV4dCIsImNhY2hlRmlsZSIsImZpbHRlcldhcm5pbmdzIiwicmVzdWx0cyIsIl8iLCJyZWR1Y2UiLCJjdXJyIiwicmVzdWx0Iiwid2FybmluZ0NvdW50IiwibmV3UmVzdWx0Iiwib21pdCIsIm1lc3NhZ2VzIiwiZmlsdGVyIiwibSIsInNldmVyaXR5IiwicHVzaCIsInJlcXVpcmVGb3JtYXR0ZXIiLCJmb3JtYXR0ZXJQYXRoIiwicmVxdWlyZSIsImV4IiwibWVzc2FnZSIsImdldEZvcm1hdHRlciIsImNsaSIsImZvcm1hdHRlciIsInBhdGhUb0Zvcm1hdHRlclNwZWNpZmllZCIsImluY2x1ZGVzIiwiaXNTaW1wbGVGb3JtYXR0ZXIiLCJyZXBsYWNlIiwiY3dkIiwicHJvY2VzcyIsImxvY2F0aW9uIiwicGF0aCIsInJlc29sdmUiLCJ3YXRjaGVyIiwib3B0aW9ucyIsImNsaU9wdGlvbnMiLCJwaWNrIiwidmFsdWUiLCJrZXkiLCJlc2xpbnQiLCJDTElFbmdpbmUiLCJ3YXRjaERpciIsImxlbmd0aCIsImZvcm1hdCIsImxpbnRGaWxlIiwiY2xlYXIiLCJyZXBvcnQiLCJleGVjdXRlT25GaWxlcyIsImZpeCIsIm91dHB1dEZpeGVzIiwic2V0dGluZ3MiLCJxdWlldCIsImxvZyIsImlzV2F0Y2hhYmxlRXh0ZW5zaW9uIiwiZmlsZVBhdGgiLCJleHRlbnNpb25zIiwiZXh0ZW5zaW9uIiwiZXh0bmFtZSIsImRvdEV4dGVuc2lvbnMiLCJtYXAiLCJlIiwibWF0Y2giLCJjaG9raWRhciIsIndhdGNoIiwib24iLCJjaGFuZ2VFdmVudCIsImlzUGF0aElnbm9yZWQiLCJ3YXRjaFBhdGgiLCJjaGFuZ2VkIiwiZXJyb3IiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7OztBQUVBLE1BQU1BLFNBQVMscUJBQU8sU0FBUCxDQUFmO0FBRUFBLE9BQU9DLEtBQVAsQ0FBYSxRQUFiO0FBRUEsTUFBTUMsU0FBUztBQUFFQyxVQUFRO0FBQVYsQ0FBZjtBQUNBLE1BQU1DLGtCQUFrQjtBQUN0QkMsV0FBUztBQURhLENBQXhCO0FBR0EsTUFBTUMsc0JBQXNCLENBQzFCLFFBRDBCLEVBRTFCLFVBRjBCLEVBRzFCLEtBSDBCLEVBSTFCLFFBSjBCLEVBSzFCLE9BTDBCLEVBTTFCLGVBTjBCLEVBTzFCLFFBUDBCLEVBUTFCLFlBUjBCLEVBUzFCLGVBVDBCLEVBVTFCLEtBVjBCLEVBVzFCLGVBWDBCLEVBWTFCLFFBWjBCLENBQTVCO0FBY0EsTUFBTUMsZUFBZTtBQUNuQkMsVUFBUSxZQURXO0FBRW5CQyxZQUFVLGFBRlM7QUFHbkJDLE9BQUssWUFIYztBQUluQkMsYUFBVztBQUpRLENBQXJCOztBQU9BLFNBQVNDLGNBQVQsQ0FBd0JDLE9BQXhCLEVBQWlDO0FBQy9CLFNBQU9DLGdCQUFFQyxNQUFGLENBQ0xGLE9BREssRUFFTCxDQUFDRyxJQUFELEVBQU9DLE1BQVAsS0FBa0I7QUFDaEIsUUFBSUEsT0FBT0MsWUFBWCxFQUF5QjtBQUN2QixVQUFJQyxZQUFZTCxnQkFBRU0sSUFBRixDQUFPSCxNQUFQLEVBQWUsVUFBZixDQUFoQjs7QUFDQUUsZ0JBQVVFLFFBQVYsR0FBcUJQLGdCQUFFUSxNQUFGLENBQVNMLE9BQU9JLFFBQWhCLEVBQTJCRSxDQUFELElBQU9BLEVBQUVDLFFBQUYsR0FBYSxDQUE5QyxDQUFyQjtBQUNBUixXQUFLUyxJQUFMLENBQVVOLFNBQVY7QUFDQSxhQUFPSCxJQUFQO0FBQ0Q7O0FBQ0RBLFNBQUtTLElBQUwsQ0FBVVIsTUFBVjtBQUNBLFdBQU9ELElBQVA7QUFDRCxHQVhJLEVBWUwsRUFaSyxDQUFQO0FBY0Q7O0FBRUQsU0FBU1UsZ0JBQVQsQ0FBMEJDLGFBQTFCLEVBQXlDO0FBQ3ZDLE1BQUk7QUFDRixXQUFPQyxRQUFRRCxhQUFSLENBQVA7QUFDRCxHQUZELENBRUUsT0FBT0UsRUFBUCxFQUFXO0FBQ1hBLE9BQUdDLE9BQUgsR0FBYywwQ0FBeUNILGFBQWMsWUFBV0UsR0FBR0MsT0FBUSxFQUEzRjtBQUNBLFVBQU1ELEVBQU47QUFDRDtBQUNGOztBQUVELFNBQVNFLFlBQVQsQ0FBc0JDLEdBQXRCLEVBQTJCQyxTQUEzQixFQUFzQztBQUNwQyxRQUFNQywyQkFBMkJELFVBQVVFLFFBQVYsQ0FBbUIsSUFBbkIsQ0FBakM7QUFDQSxRQUFNQyxvQkFBb0JILFVBQVVFLFFBQVYsQ0FBbUIsUUFBbkIsQ0FBMUI7QUFDQSxRQUFNUixnQkFBZ0JNLFVBQVVJLE9BQVYsQ0FBa0IsS0FBbEIsRUFBeUIsR0FBekIsQ0FBdEI7O0FBRUEsTUFBSUQsaUJBQUosRUFBdUI7QUFDckJwQyxXQUFPQyxLQUFQLENBQWMsb0JBQW1CZ0MsU0FBVSxFQUEzQztBQUVBLFdBQU9QLGlCQUFrQixnQkFBZUMsYUFBYyxFQUEvQyxDQUFQO0FBQ0QsR0FKRCxNQUlPLElBQUlPLHdCQUFKLEVBQThCO0FBQ25DLFVBQU1JLE1BQU1DLFFBQVFELEdBQVIsRUFBWjtBQUVBdEMsV0FBT0MsS0FBUCxDQUFhLGlCQUFiLEVBQWdDMEIsYUFBaEM7O0FBQ0EsVUFBTWEsV0FBV0MsY0FBS0MsT0FBTCxDQUFhSixHQUFiLEVBQWtCWCxhQUFsQixDQUFqQjs7QUFFQSxXQUFPRCxpQkFBaUJjLFFBQWpCLENBQVA7QUFDRDs7QUFFRHhDLFNBQU9DLEtBQVAsQ0FBYyxxQkFBb0JnQyxTQUFVLEVBQTVDO0FBRUEsU0FBT0QsSUFBSUQsWUFBSixDQUFpQkUsU0FBakIsQ0FBUDtBQUNELEMsQ0FFRDs7O0FBRWUsU0FBU1UsT0FBVCxDQUFpQkMsT0FBakIsRUFBMEI7QUFDdkMsUUFBTUMsYUFBYSxxQkFBRUQsT0FBRixFQUNoQkUsSUFEZ0IsQ0FDWHhDLG1CQURXLEVBRWhCUyxNQUZnQixDQUVULFVBQVNFLE1BQVQsRUFBaUI4QixLQUFqQixFQUF3QkMsR0FBeEIsRUFBNkI7QUFDbkNBLFVBQU16QyxhQUFheUMsR0FBYixLQUFxQkEsR0FBM0I7QUFDQS9CLFdBQU8rQixHQUFQLElBQWNELEtBQWQ7QUFDQSxXQUFPOUIsTUFBUDtBQUNELEdBTmdCLEVBTWQsRUFOYyxDQUFuQjtBQU9BakIsU0FBT0MsS0FBUCxDQUFhLEtBQWIsRUFBb0I0QyxVQUFwQjtBQUNBN0MsU0FBT0MsS0FBUCxDQUFhLFNBQWIsRUFBd0IyQyxPQUF4QjtBQUNBLFFBQU1aLE1BQU0sSUFBSWlCLGdCQUFPQyxTQUFYLENBQXFCTCxVQUFyQixDQUFaO0FBQ0EsUUFBTU0sV0FBV1AsUUFBUTlCLENBQVIsQ0FBVXNDLE1BQVYsR0FBbUJSLFFBQVE5QixDQUEzQixHQUErQixDQUFDMkIsY0FBS0MsT0FBTCxDQUFhLElBQWIsQ0FBRCxDQUFoRDtBQUVBLFFBQU1ULFlBQVlGLGFBQWFDLEdBQWIsRUFBa0JZLFFBQVFTLE1BQTFCLENBQWxCOztBQUVBLFdBQVNDLFFBQVQsQ0FBa0JiLElBQWxCLEVBQXdCO0FBQ3RCekMsV0FBT0MsS0FBUCxDQUFhLGNBQWIsRUFBNkJ3QyxJQUE3Qjs7QUFDQSxRQUFJRyxRQUFRVyxLQUFaLEVBQW1CO0FBQ2pCO0FBQ0Q7O0FBQ0QsVUFBTUMsU0FBU3hCLElBQUl5QixjQUFKLENBQW1CaEIsSUFBbkIsQ0FBZjs7QUFDQSxRQUFJRyxRQUFRYyxHQUFaLEVBQWlCO0FBQ2ZULHNCQUFPQyxTQUFQLENBQWlCUyxXQUFqQixDQUE2QkgsTUFBN0I7QUFDRDs7QUFDRCxVQUFNM0MsVUFBVStDLGtCQUFTZixVQUFULENBQW9CZ0IsS0FBcEIsR0FBNEJqRCxlQUFlNEMsT0FBTzNDLE9BQXRCLENBQTVCLEdBQTZEMkMsT0FBTzNDLE9BQXBGO0FBRUFiLFdBQU84RCxHQUFQLENBQVc3QixVQUFVcEIsT0FBVixDQUFYO0FBQ0Q7O0FBRUQsV0FBU2tELG9CQUFULENBQThCQyxRQUE5QixFQUF3Q0MsYUFBYWpDLElBQUlZLE9BQUosQ0FBWXFCLFVBQWpFLEVBQTZFO0FBQzNFLFVBQU1DLFlBQVl6QixjQUFLMEIsT0FBTCxDQUFhSCxRQUFiLENBQWxCOztBQUNBLFVBQU1JLGdCQUFnQkgsV0FBV0ksR0FBWCxDQUFnQkMsQ0FBRCxJQUFPO0FBQzFDLFVBQUksQ0FBQ0EsRUFBRUMsS0FBRixDQUFRLEtBQVIsQ0FBTCxFQUFxQjtBQUNuQixlQUFRLElBQUdELENBQUUsRUFBYjtBQUNEOztBQUNELGFBQU9BLENBQVA7QUFDRCxLQUxxQixDQUF0QjtBQU9BdEUsV0FBT0MsS0FBUCxDQUFhaUUsU0FBYixFQUF3QkUsYUFBeEI7O0FBQ0EsUUFBSUEsY0FBY2hCLE1BQWQsR0FBdUIsQ0FBM0IsRUFBOEI7QUFDNUIsYUFBT3RDLGdCQUFFcUIsUUFBRixDQUFXaUMsYUFBWCxFQUEwQkYsU0FBMUIsQ0FBUDtBQUNELEtBWjBFLENBYzNFOzs7QUFDQSxXQUFPcEQsZ0JBQUVxQixRQUFGLENBQVdILElBQUlZLE9BQUosQ0FBWXFCLFVBQXZCLEVBQW1DQyxTQUFuQyxDQUFQO0FBQ0Q7O0FBRURNLG9CQUNHQyxLQURILENBQ1N0QixRQURULEVBQ21CL0MsZUFEbkIsRUFFR3NFLEVBRkgsQ0FFTXhFLE9BQU9DLE1BRmIsRUFFcUIsU0FBU3dFLFdBQVQsQ0FBcUJsQyxJQUFyQixFQUEyQjtBQUM1Q3pDLFdBQU9DLEtBQVAsQ0FBYSxVQUFiLEVBQXlCd0MsSUFBekI7O0FBQ0EsUUFBSSxDQUFDVCxJQUFJNEMsYUFBSixDQUFrQm5DLElBQWxCLENBQUQsSUFBNEJzQixxQkFBcUJ0QixJQUFyQixFQUEyQkcsUUFBUWxDLEdBQW5DLENBQWhDLEVBQXlFO0FBQ3ZFLFlBQU1tRSxZQUFZakMsUUFBUWtDLE9BQVIsR0FBa0IsQ0FBQ3JDLElBQUQsQ0FBbEIsR0FBMkJVLFFBQTdDO0FBRUFHLGVBQVN1QixTQUFUO0FBQ0Q7QUFDRixHQVRILEVBVUdILEVBVkgsQ0FVTSxPQVZOLEVBVWUxRSxPQUFPK0UsS0FWdEI7O0FBWUEvRSxTQUFPQyxLQUFQLENBQWEsY0FBYixFQUE2QmtELFFBQTdCO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY2hva2lkYXIgZnJvbSAnY2hva2lkYXInO1xuaW1wb3J0IGVzbGludCBmcm9tICdlc2xpbnQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuXG5pbXBvcnQgc2V0dGluZ3MgZnJvbSAnLi9zZXR0aW5ncyc7XG5pbXBvcnQgTG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBjbGVhclRlcm1pbmFsIGZyb20gJy4vZm9ybWF0dGVycy9oZWxwZXJzL2NsZWFyLXRlcm1pbmFsLmpzJztcblxuY29uc3QgbG9nZ2VyID0gTG9nZ2VyKCd3YXRjaGVyJyk7XG5cbmxvZ2dlci5kZWJ1ZygnTG9hZGVkJyk7XG5cbmNvbnN0IGV2ZW50cyA9IHsgY2hhbmdlOiAnY2hhbmdlJyB9O1xuY29uc3QgY2hva2lkYXJPcHRpb25zID0ge1xuICBpZ25vcmVkOiAvXFwuZ2l0fG5vZGVfbW9kdWxlc3xib3dlcl9jb21wb25lbnRzLyxcbn07XG5jb25zdCBjbGlPcHRpb25Qcm9wZXJ0aWVzID0gW1xuICAnY29uZmlnJyxcbiAgJ2VzbGludHJjJyxcbiAgJ2V4dCcsXG4gICdwYXJzZXInLFxuICAnY2FjaGUnLFxuICAnY2FjaGVMb2NhdGlvbicsXG4gICdpZ25vcmUnLFxuICAnaWdub3JlUGF0aCcsXG4gICdpZ25vcmVQYXR0ZXJuJyxcbiAgJ2ZpeCcsXG4gICdwYXJzZXJPcHRpb25zJyxcbiAgJ2dsb2JhbCcsXG5dO1xuY29uc3QgY2xpT3B0aW9uTWFwID0ge1xuICBjb25maWc6ICdjb25maWdGaWxlJyxcbiAgZXNsaW50cmM6ICd1c2VFc2xpbnRyYycsXG4gIGV4dDogJ2V4dGVuc2lvbnMnLFxuICBjYWNoZUZpbGU6ICdjYWNoZUxvY2F0aW9uJyxcbn07XG5cbmZ1bmN0aW9uIGZpbHRlcldhcm5pbmdzKHJlc3VsdHMpIHtcbiAgcmV0dXJuIF8ucmVkdWNlKFxuICAgIHJlc3VsdHMsXG4gICAgKGN1cnIsIHJlc3VsdCkgPT4ge1xuICAgICAgaWYgKHJlc3VsdC53YXJuaW5nQ291bnQpIHtcbiAgICAgICAgbGV0IG5ld1Jlc3VsdCA9IF8ub21pdChyZXN1bHQsICdtZXNzYWdlcycpO1xuICAgICAgICBuZXdSZXN1bHQubWVzc2FnZXMgPSBfLmZpbHRlcihyZXN1bHQubWVzc2FnZXMsIChtKSA9PiBtLnNldmVyaXR5ID4gMSk7XG4gICAgICAgIGN1cnIucHVzaChuZXdSZXN1bHQpO1xuICAgICAgICByZXR1cm4gY3VycjtcbiAgICAgIH1cbiAgICAgIGN1cnIucHVzaChyZXN1bHQpO1xuICAgICAgcmV0dXJuIGN1cnI7XG4gICAgfSxcbiAgICBbXVxuICApO1xufVxuXG5mdW5jdGlvbiByZXF1aXJlRm9ybWF0dGVyKGZvcm1hdHRlclBhdGgpIHtcbiAgdHJ5IHtcbiAgICByZXR1cm4gcmVxdWlyZShmb3JtYXR0ZXJQYXRoKTtcbiAgfSBjYXRjaCAoZXgpIHtcbiAgICBleC5tZXNzYWdlID0gYFRoZXJlIHdhcyBhIHByb2JsZW0gbG9hZGluZyBmb3JtYXR0ZXI6ICR7Zm9ybWF0dGVyUGF0aH1cXG5FcnJvcjogJHtleC5tZXNzYWdlfWA7XG4gICAgdGhyb3cgZXg7XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0Rm9ybWF0dGVyKGNsaSwgZm9ybWF0dGVyKSB7XG4gIGNvbnN0IHBhdGhUb0Zvcm1hdHRlclNwZWNpZmllZCA9IGZvcm1hdHRlci5pbmNsdWRlcygnXFxcXCcpO1xuICBjb25zdCBpc1NpbXBsZUZvcm1hdHRlciA9IGZvcm1hdHRlci5pbmNsdWRlcygnc2ltcGxlJyk7XG4gIGNvbnN0IGZvcm1hdHRlclBhdGggPSBmb3JtYXR0ZXIucmVwbGFjZSgvXFxcXC9nLCAnLycpO1xuXG4gIGlmIChpc1NpbXBsZUZvcm1hdHRlcikge1xuICAgIGxvZ2dlci5kZWJ1ZyhgRm9ybWF0dGVyIGxvY2FsOiAke2Zvcm1hdHRlcn1gKTtcblxuICAgIHJldHVybiByZXF1aXJlRm9ybWF0dGVyKGAuL2Zvcm1hdHRlcnMvJHtmb3JtYXR0ZXJQYXRofWApO1xuICB9IGVsc2UgaWYgKHBhdGhUb0Zvcm1hdHRlclNwZWNpZmllZCkge1xuICAgIGNvbnN0IGN3ZCA9IHByb2Nlc3MuY3dkKCk7XG5cbiAgICBsb2dnZXIuZGVidWcoJ0Zvcm1hdHRlciB1c2VyOicsIGZvcm1hdHRlclBhdGgpO1xuICAgIGNvbnN0IGxvY2F0aW9uID0gcGF0aC5yZXNvbHZlKGN3ZCwgZm9ybWF0dGVyUGF0aCk7XG5cbiAgICByZXR1cm4gcmVxdWlyZUZvcm1hdHRlcihsb2NhdGlvbik7XG4gIH1cblxuICBsb2dnZXIuZGVidWcoYEZvcm1hdHRlciBlc2xpbnQ6ICR7Zm9ybWF0dGVyfWApO1xuXG4gIHJldHVybiBjbGkuZ2V0Rm9ybWF0dGVyKGZvcm1hdHRlcik7XG59XG5cbi8vL2h0dHBzOi8vZ2l0aHViLmNvbS9lc2xpbnQvZXNsaW50L2Jsb2IvMjMzNDQwZTUyNGFhNDE1NDViNjZiMmMzYzdjYTI2ZmU3OTBlMzJlMC90ZXN0cy9saWIvY2xpLWVuZ2luZS5qcyNMMTA1LUwxMDdcblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gd2F0Y2hlcihvcHRpb25zKSB7XG4gIGNvbnN0IGNsaU9wdGlvbnMgPSBfKG9wdGlvbnMpXG4gICAgLnBpY2soY2xpT3B0aW9uUHJvcGVydGllcylcbiAgICAucmVkdWNlKGZ1bmN0aW9uKHJlc3VsdCwgdmFsdWUsIGtleSkge1xuICAgICAga2V5ID0gY2xpT3B0aW9uTWFwW2tleV0gfHwga2V5O1xuICAgICAgcmVzdWx0W2tleV0gPSB2YWx1ZTtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSwge30pO1xuICBsb2dnZXIuZGVidWcoJ2NsaScsIGNsaU9wdGlvbnMpO1xuICBsb2dnZXIuZGVidWcoJ29wdGlvbnMnLCBvcHRpb25zKTtcbiAgY29uc3QgY2xpID0gbmV3IGVzbGludC5DTElFbmdpbmUoY2xpT3B0aW9ucyk7XG4gIGNvbnN0IHdhdGNoRGlyID0gb3B0aW9ucy5fLmxlbmd0aCA/IG9wdGlvbnMuXyA6IFtwYXRoLnJlc29sdmUoJy4vJyldO1xuXG4gIGNvbnN0IGZvcm1hdHRlciA9IGdldEZvcm1hdHRlcihjbGksIG9wdGlvbnMuZm9ybWF0KTtcblxuICBmdW5jdGlvbiBsaW50RmlsZShwYXRoKSB7XG4gICAgbG9nZ2VyLmRlYnVnKCdsaW50RmlsZTogJXMnLCBwYXRoKTtcbiAgICBpZiAob3B0aW9ucy5jbGVhcikge1xuICAgICAgY2xlYXJUZXJtaW5hbCgpO1xuICAgIH1cbiAgICBjb25zdCByZXBvcnQgPSBjbGkuZXhlY3V0ZU9uRmlsZXMocGF0aCk7XG4gICAgaWYgKG9wdGlvbnMuZml4KSB7XG4gICAgICBlc2xpbnQuQ0xJRW5naW5lLm91dHB1dEZpeGVzKHJlcG9ydCk7XG4gICAgfVxuICAgIGNvbnN0IHJlc3VsdHMgPSBzZXR0aW5ncy5jbGlPcHRpb25zLnF1aWV0ID8gZmlsdGVyV2FybmluZ3MocmVwb3J0LnJlc3VsdHMpIDogcmVwb3J0LnJlc3VsdHM7XG5cbiAgICBsb2dnZXIubG9nKGZvcm1hdHRlcihyZXN1bHRzKSk7XG4gIH1cblxuICBmdW5jdGlvbiBpc1dhdGNoYWJsZUV4dGVuc2lvbihmaWxlUGF0aCwgZXh0ZW5zaW9ucyA9IGNsaS5vcHRpb25zLmV4dGVuc2lvbnMpIHtcbiAgICBjb25zdCBleHRlbnNpb24gPSBwYXRoLmV4dG5hbWUoZmlsZVBhdGgpO1xuICAgIGNvbnN0IGRvdEV4dGVuc2lvbnMgPSBleHRlbnNpb25zLm1hcCgoZSkgPT4ge1xuICAgICAgaWYgKCFlLm1hdGNoKC9eXFwuLykpIHtcbiAgICAgICAgcmV0dXJuIGAuJHtlfWA7XG4gICAgICB9XG4gICAgICByZXR1cm4gZTtcbiAgICB9KTtcblxuICAgIGxvZ2dlci5kZWJ1ZyhleHRlbnNpb24sIGRvdEV4dGVuc2lvbnMpO1xuICAgIGlmIChkb3RFeHRlbnNpb25zLmxlbmd0aCA+IDApIHtcbiAgICAgIHJldHVybiBfLmluY2x1ZGVzKGRvdEV4dGVuc2lvbnMsIGV4dGVuc2lvbik7XG4gICAgfVxuXG4gICAgLy8gVXNlIHRoZSBFU0xpbnQgZGVmYXVsdCBleHRlbnNpb24sIGlmIG5vbmUgaXMgcHJvdmlkZWRcbiAgICByZXR1cm4gXy5pbmNsdWRlcyhjbGkub3B0aW9ucy5leHRlbnNpb25zLCBleHRlbnNpb24pO1xuICB9XG5cbiAgY2hva2lkYXJcbiAgICAud2F0Y2god2F0Y2hEaXIsIGNob2tpZGFyT3B0aW9ucylcbiAgICAub24oZXZlbnRzLmNoYW5nZSwgZnVuY3Rpb24gY2hhbmdlRXZlbnQocGF0aCkge1xuICAgICAgbG9nZ2VyLmRlYnVnKCdDaGFuZ2VkOicsIHBhdGgpO1xuICAgICAgaWYgKCFjbGkuaXNQYXRoSWdub3JlZChwYXRoKSAmJiBpc1dhdGNoYWJsZUV4dGVuc2lvbihwYXRoLCBvcHRpb25zLmV4dCkpIHtcbiAgICAgICAgY29uc3Qgd2F0Y2hQYXRoID0gb3B0aW9ucy5jaGFuZ2VkID8gW3BhdGhdIDogd2F0Y2hEaXI7XG5cbiAgICAgICAgbGludEZpbGUod2F0Y2hQYXRoKTtcbiAgICAgIH1cbiAgICB9KVxuICAgIC5vbignZXJyb3InLCBsb2dnZXIuZXJyb3IpO1xuXG4gIGxvZ2dlci5kZWJ1ZygnV2F0Y2hpbmc6ICVvJywgd2F0Y2hEaXIpO1xufVxuIl19